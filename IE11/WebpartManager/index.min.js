"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.InstallList = InstallList;
exports.RemoveList = RemoveList;

var _FactoryMin = require("./Factory.min.js");

var _FactoryMin2 = _interopRequireDefault(_FactoryMin);

var _Route = require("./Route.js");

var _Route2 = _interopRequireDefault(_Route);

var _WebpartsList = require("./Webparts.List.js");

var _WebpartsList2 = _interopRequireDefault(_WebpartsList);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

async function InstallList(event) {

    /*JoePC*/var isPointerEvent = event && event.constructor && event.constructor.name && event.constructor.name === 'PointerEvent';

    var Element = void 0,
        OriginalHTML = void 0;

    if (isPointerEvent) {
        Element = event.target.tagName === 'BUTTON' ? event.target : event.target.closest('button');

        OriginalHTML = Element.innerHTML;

        /** Disable button; */
        Element.setAttribute('disabled', '');
        Element.innerHTML = /*html*/"\n        <span class=\"spinner-border spinner-border-sm\" \n            role=\"status\" \n            aria-hidden=\"true\">\n        </span> Loading...";
    }

    var _getWebpart = this.getWebpart();

    var schema = _getWebpart.schema;

    var Web = this.Web;
    var Callback = this.callback;
    var List = await _Route2.default.Get(Web.Url + "/_api/Web/Lists/getByTitle('" + schema.list.Title + "')");
    if (List) {
        alert('This list has already been created!');
        if (isPointerEvent) $(Element).html(OriginalHTML).removeAttr('disabled');
    } else {
        var ReqDigest = await _Route2.default.GetRequestDigest();
        var NewList = await (0, _FactoryMin2.default)({
            Route: _Route2.default,
            Web: Web
        }, {
            AddViewFieldTitle: false,
            AddViewFieldGUID: false,
            List: schema.list,
            Fields: schema.fields,
            PredefinedData: null
        }, Callback);

        /** Clean up the Title field, change Title required to false; */
        return _Route2.default.Patch(NewList.__metadata.uri + "/Fields/getByTitle('Title')", {
            Required: false,
            __metadata: {
                type: 'SP.FieldText'
            }
        }, ReqDigest).then(function (data) {
            return location.reload();
        });
    }
} /** 
   * index.min.js
   * @description This is the bare bones version of the webpart manager,
   * this only calls the Bootstrap CSS, jQuery & Bootstrap JavaScript is removed.
   * @author Wilfredo Pacheco
   */

async function RemoveList(event) {

    /*JoePC */var isPointerEvent = event && event.constructor && event.constructor.name && event.constructor.name === 'PointerEvent';

    var Element = void 0,
        OriginalHTML = void 0;

    if (isPointerEvent) {
        Element = event.target.tagName === 'BUTTON' ? event.target : event.target.closest('button');

        OriginalHTML = Element.innerHTML;

        /** Disable button; */
        Element.setAttribute('disabled', '');
        Element.innerHTML = /*html*/"\n        <span class=\"spinner-border spinner-border-sm\" \n            role=\"status\" \n            aria-hidden=\"true\">\n        </span> Loading...";
    }

    var _getWebpart2 = this.getWebpart();

    var schema = _getWebpart2.schema;

    var Web = this.Web;
    var List = await _Route2.default.Get(Web.Url + "/_api/Web/Lists/getByTitle('" + schema.list.Title + "')");
    var ReqDigest = await _Route2.default.GetRequestDigest();
    if (!List) {
        alert('This list has not been created!');
        if (isPointerEvent) {
            Element.innerHTML = OriginalHTML;
            Element.removeAttribute('disabled');
        }
    } else return _Route2.default.Delete(List.__metadata.uri, ReqDigest).then(function (data) {
        return location.reload();
    });
}

var xIcon = /*svg*/"\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-x-circle-fill text-danger\" viewBox=\"0 0 16 16\">\n    <path d=\"M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z\"/>\n</svg>";

var checkIcon = /*svg*/"\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-check-circle-fill text-success\" viewBox=\"0 0 16 16\">\n    <path d=\"M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z\"/>\n</svg>";

(function () {

    var Container = document.createElement('div');
    var DisplayElement = document.createElement('div');
    var favicon = document.createElement('link');
    favicon.setAttribute('rel', 'shortcut icon');
    favicon.setAttribute('href', '/_layouts/15/images/favicon.ico?rev=23');
    favicon.setAttribute('type', 'image/vnd.microsoft.icon');
    favicon.setAttribute('id', 'favicon');

    /** DOMContentLoaded Event; */
    document.addEventListener('DOMContentLoaded', function RenderContent(event) {
        document.head.append(favicon);
        document.title = 'Webpart Manager';
        document.body.classList.add('container');
        document.body.append(Container);
        // $(document.body).append(`<img src="_layouts/15/images/siteIcon.png?rev=40" />`);
        Container.classList = 'card-body col-xl-6 col-lg-8 col-md-10 col-sm-11 shadow-lg';
        Container.setAttribute('style', 'border-radius: 1.25rem!important; position: absolute!important;top: 40%;left: 50%;transform: translate(-50%, -50%);background-color: #eeeeff !important;');
        Container.innerHTML = /*html*/"<!-- Form Container Content -->\n        <div class=\"p-4 text-center\">\n            <h1>" + document.title + "</h1>\n        </div>\n        <div id=\"settings-panel\"></div>\n        <table class=\"table table-sm table-hover\">\n            <thead>\n                <tr>\n                    <th>Title</th>\n                    <th class=\"text-center\">Installed</th>\n                    <th class=\"\">Actions</th>\n                </tr>\n            </thead>\n            <tbody></tbody>\n        </table>";
    });

    /** window.onload Event; */
    async function init() {

        var SettingsPanel = Container.querySelector('div#settings-panel');
        var TableBody = Container.querySelector('table tbody');

        /** Call to get the Microsoft SharePoint Web Object; */
        var Web = await _Route2.default.init(_Route.SiteCollectionUrl + "/_api/Web", {
            $select: '*',
            $expand: 'Lists,RegionalSettings,CurrentUser,Folders'
        });

        SettingsPanel.classList = 'text-right';
        SettingsPanel.innerHTML = /*html*/"\n        <a class=\"m-1\" href=\"" + Web.Url + "\" target=\"_blank\">Home</a>\n        <a class=\"m-1\" href=\"" + Web.Url + "/_layouts/15/viewlsts.aspx\" target=\"_blank\">Site Contents</a>\n        <a class=\"m-1\" href=\"" + Web.Url + "/_layouts/15/Settings.aspx\" target=\"_blank\">Settings</a>";

        _WebpartsList2.default.forEach(function (wp) {

            var IconContainer = document.createElement('span');
            var isFound = Web.getListDetails(wp.schema.list.Title);
            IconContainer.innerHTML = !!isFound ? checkIcon : xIcon;

            var title = wp.title;
            var id = wp.id;

            var tr = document.createElement('tr');
            tr.innerHTML = /*html*/"\n            <td>" + title + "</td>\n            <td class=\"text-center\">" + IconContainer.outerHTML + "</td>\n            <td class=\"\">\n                <div class=\"btn-group\" role=\"group\" aria-label=\"Basic example\">\n                    <button type=\"button\" id=\"install-" + id + "\" class=\"btn btn-outline-secondary btn-sm\">Install</button>\n                    <button type=\"button\" id=\"remove-" + id + "\" class=\"btn btn-outline-secondary btn-sm\">Remove</button>\n                    <a id=\"link-" + id + "\" href=\"" + (!!isFound ? Web.Url + "/Lists/" + wp.schema.list.Title + "/AllItems.aspx" : "javascript:alert('The list " + wp.schema.list.Title + " has not been created, please click the install button to create the list.');") + "\" class=\"btn btn-outline-secondary btn-sm\" " + (!!isFound ? "target=\"_blank\"" : '') + " >\n                        <img style=\"width: 16px;\" src=\"/_layouts/15/images/favicon.ico?rev=23\" /> Visit List\n                    </a>\n                </div>\n            </td>";

            var InstallButton = tr.querySelector("button#install-" + id);
            var RemoveButton = tr.querySelector("button#remove-" + id);
            InstallButton.addEventListener('click', InstallList);
            RemoveButton.addEventListener('click', RemoveList);

            Object.assign(InstallButton, {
                Route: _Route2.default,
                Web: Web,
                getWebpart: function getWebpart() {
                    return wp;
                },
                callback: function callback(message) {
                    var div = document.createElement('div');
                    div.classList = 'text-primary';
                    div.setAttribute('style', 'font-size: 12px;');
                    div.innerText = message;
                    DisplayElement.append(div);
                    document.documentElement.scrollTop = document.body.scrollTop = document.body.scrollHeight;
                }
            });

            Object.assign(RemoveButton, {
                Route: _Route2.default,
                Web: Web,
                getWebpart: function getWebpart() {
                    return wp;
                }
            });

            TableBody.append(tr);
        });

        Container.append(DisplayElement);
    }

    window.onload = init;
})();